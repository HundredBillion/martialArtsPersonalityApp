<h2 class="text-2xl font-bold mb-4">Your Results</h2>

<% safe_results = @results || (@submission.result_payload || {}) %>
<% scores = safe_results[:scores] || safe_results['scores'] || {} %>
<% percentages = safe_results[:percentages] || safe_results['percentages'] || {} %>

<div class="space-y-2 mb-4">
  <% sorted_traits = ['warrior','athlete','artist'].sort_by { |p| -percentages[p].to_f } %>
  <% sorted_traits.each_with_index do |p, index| %>
    <%= link_to quiz_result_path(trait: p), data: { turbo_frame: "trait_description" },
        class: "block cursor-pointer hover:bg-gray-50 transition-colors duration-200 p-3 rounded border #{'bg-blue-50 border-blue-300' if index == 0}" do %>
      <div class="flex justify-between items-center">
        <div class="font-semibold capitalize flex items-center gap-2">
          <%= p %>
          <% if index == 0 %>
            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Primary</span>
          <% elsif index == 1 %>
            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">Secondary</span>
          <% else %>
            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">Tertiary</span>
          <% end %>
          <span class="text-xs text-gray-400">← Click to read more</span>
        </div>
        <div class="text-sm text-gray-600"><%= percentages[p].to_f %>%</div>
      </div>
      <div class="h-2 bg-gray-100 rounded mt-2">
        <div style="width: <%= percentages[p].to_f %>%" class="h-2 bg-blue-400 rounded"></div>
      </div>
    <% end %>
  <% end %>
</div>

<%= turbo_frame_tag "trait_description", class: "mt-4 min-h-[200px]" do %>
  <p class="text-lg mb-3">
    <% if @trait_rank == 0 %>
      You are primarily: <strong class="capitalize text-blue-600"><%= @current_trait %></strong>
    <% elsif @trait_rank == 1 %>
      Your secondary trait: <strong class="capitalize text-gray-700"><%= @current_trait %></strong>
    <% else %>
      Your tertiary trait: <strong class="capitalize text-gray-600"><%= @current_trait %></strong>
    <% end %>
    <span class="text-sm text-gray-500">(<%= percentages[@current_trait].to_f %>%)</span>
  </p>
  <div class="text-gray-700"><%= simple_format(@submission.description_for(@current_trait)) %></div>
<% end %>

<div class="mt-6 flex gap-2">
  <form action="<%= quiz_reset_path %>" method="post" class="w-full">
    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
    <button type="submit" class="w-full btn-secondary">Take Again</button>
  </form>
</div>
